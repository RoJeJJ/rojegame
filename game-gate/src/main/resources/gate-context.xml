<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">
    <context:property-placeholder location="classpath:gate.properties"/>
    <import resource="gate-config.xml"/>
    <bean id="serverManager" class="com.roje.game.core.manager.ServerManager"/>
    <bean id="userSessionManager" class="com.roje.game.gate.manager.GateUserSessionManager">
        <property name="serverManager" ref="serverManager"/>
    </bean>
    <bean id="messageDispatcher" class="com.roje.game.core.dispatcher.MessageDispatcher"/>
    <bean id="userServerChannelInitializer" class="com.roje.game.core.netty.channel.initializer.DefaultTcpServerChannelInitializer">
        <constructor-arg ref="gateUserServerConfig"/>
        <property name="handlers">
            <list>
                <bean class="com.roje.game.gate.netty.handler.GateUserServerChannelInBoundHandler">
                    <constructor-arg name="containUid" value="false"/>
                    <constructor-arg name="dispatcher" ref="messageDispatcher"/>
                    <constructor-arg name="service" ref="gateUserTcpServer"/>
                    <property name="sessionManager" ref="userSessionManager"/>
                </bean>
            </list>
        </property>
    </bean>
    <bean class="com.roje.game.core.netty.channel.initializer.DefaultTcpServerChannelInitializer" id="gameServerChannelInitializer">
        <constructor-arg ref="gateGameServerConfig"/>
        <property name="handlers">
            <list>
                <bean class="com.roje.game.gate.netty.handler.GateGameServerChannelInBoundHandler">
                    <constructor-arg name="containUid" value="true"/>
                    <constructor-arg name="service" ref="gateToGameTcpServer"/>
                    <constructor-arg name="dispatcher" ref="messageDispatcher"/>
                    <property name="sessionManager" ref="userSessionManager"/>
                </bean>
            </list>
        </property>
    </bean>
    <bean class="com.roje.game.core.netty.channel.initializer.DefaultClientChannelInitializer" id="clientChannelInitializer">
        <constructor-arg ref="gateClusterClientConfig"/>
        <property name="handlers">
            <list>
                <bean class="com.roje.game.core.netty.channel.handler.DefaultToClusterTcpClientChannelInBoundHandler">
                    <constructor-arg name="containUid" value="false"/>
                    <constructor-arg name="service" ref="gateToClusterTcpClient"/>
                    <constructor-arg name="dispatcher" ref="messageDispatcher"/>
                    <property name="userManager" ref="userSessionManager"/>
                    <property name="baseInfo" ref="gateInfo"/>
                </bean>
            </list>
        </property>
    </bean>
    <!--netty服务器-->
    <bean id="userTcpNettyServer" class="com.roje.game.core.netty.NettyTcpServer">
        <constructor-arg index="0" ref="userServerChannelInitializer"/>
        <constructor-arg index="1" ref="gateUserServerConfig"/>
    </bean>
    <!--netty服务器-->
    <bean id="gameTcpNettyServer" class="com.roje.game.core.netty.NettyTcpServer">
        <constructor-arg index="0" ref="gameServerChannelInitializer"/>
        <constructor-arg index="1" ref="gateGameServerConfig"/>
    </bean>
    <!--netty客户端-->
    <bean id="gateClusterTcpNettyClient" class="com.roje.game.core.netty.NettyTcpClient">
        <constructor-arg index="0" name="clientConfig" ref="gateClusterClientConfig"/>
        <constructor-arg index="1" name="initializer" ref="clientChannelInitializer"/>
    </bean>

    <!--连接用户的服务器-->
    <bean id="gateUserTcpServer" class="com.roje.game.gate.server.GateToUserTcpTcpServer">
        <constructor-arg index="0" ref="threadConfig"/>
        <constructor-arg index="1" ref="userTcpNettyServer"/>
        <property name="userSessionManager" ref="userSessionManager"/>
    </bean>
    <!--连接其他服务器的服务器-->
    <bean id="gateToGameTcpServer" class="com.roje.game.gate.server.GateToGameTcpServer">
        <constructor-arg ref="gameTcpNettyServer"/>
    </bean>
    <!---->
    <!--连接集群服务器的client-->
    <bean id="gateToClusterTcpClient" class="com.roje.game.gate.client.GateToClusterTcpClient">
        <constructor-arg index="0" name="tcpClient" ref="gateClusterTcpNettyClient"/>
    </bean>
    <!--消息处理-->
    <bean class="com.roje.game.gate.processor.impl.user.HeartBeatProcessor">
        <property name="dispatcher" ref="messageDispatcher"/>
        <property name="sessionManager" ref="userSessionManager"/>
    </bean>
    <bean class="com.roje.game.gate.processor.impl.user.LoginReqProcessor">
        <property name="dispatcher" ref="messageDispatcher"/>
        <property name="sessionManager" ref="userSessionManager"/>
        <property name="gateInfo" ref="gateInfo"/>
    </bean>
    <bean class="com.roje.game.gate.processor.impl.cluster.ServerRegRespProcessor" init-method="register">
        <property name="dispatcher" ref="messageDispatcher"/>
        <property name="gateInfo" ref="gateInfo"/>
    </bean>
    <bean class="com.roje.game.gate.processor.impl.cluster.ServerUpdateRespProcessor" init-method="register">
        <property name="dispatcher" ref="messageDispatcher"/>
    </bean>
    <bean class="com.roje.game.gate.processor.impl.game.LoginRespProcessor" init-method="register">
        <property name="dispatcher" ref="messageDispatcher"/>
        <property name="sessionManager" ref="userSessionManager"/>
    </bean>
</beans>